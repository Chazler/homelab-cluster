{{- if .Values.policies.envoyOidc.enabled }}
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-envoy-oidc-securitypolicy
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: clone-oidc-client-id
      skipBackgroundRequests: true
      match:
        any:
          - resources:
              kinds:
                - gateway.networking.k8s.io/v1/HTTPRoute
              selector:
                matchLabels:
                  {{ .Values.policies.envoyOidc.labelKey }}: {{ .Values.policies.envoyOidc.labelValue | quote }}
      generate:
        apiVersion: v1
        kind: Secret
        name: {{ required "policies.envoyOidc.clientIDSecretName is required when enabled" .Values.policies.envoyOidc.clientIDSecretName | quote }}
        namespace: {{ "{{request.object.metadata.namespace}}" | quote }}
        synchronize: true
        clone:
          namespace: {{ required "policies.envoyOidc.secretNamespace is required when enabled" .Values.policies.envoyOidc.secretNamespace | quote }}
          name: {{ required "policies.envoyOidc.clientIDSecretName is required when enabled" .Values.policies.envoyOidc.clientIDSecretName | quote }}

    - name: clone-oidc-client-secret
      skipBackgroundRequests: true
      match:
        any:
          - resources:
              kinds:
                - gateway.networking.k8s.io/v1/HTTPRoute
              selector:
                matchLabels:
                  {{ .Values.policies.envoyOidc.labelKey }}: {{ .Values.policies.envoyOidc.labelValue | quote }}
      generate:
        apiVersion: v1
        kind: Secret
        name: {{ required "policies.envoyOidc.clientSecretName is required when enabled" .Values.policies.envoyOidc.clientSecretName | quote }}
        namespace: {{ "{{request.object.metadata.namespace}}" | quote }}
        synchronize: true
        clone:
          namespace: {{ required "policies.envoyOidc.secretNamespace is required when enabled" .Values.policies.envoyOidc.secretNamespace | quote }}
          name: {{ required "policies.envoyOidc.clientSecretName is required when enabled" .Values.policies.envoyOidc.clientSecretName | quote }}

    - name: generate-securitypolicy-protected
      match:
        any:
          - resources:
              kinds:
                - gateway.networking.k8s.io/v1/HTTPRoute
              selector:
                matchLabels:
                  {{ .Values.policies.envoyOidc.labelKey }}: {{ .Values.policies.envoyOidc.labelValue | quote }}
      skipBackgroundRequests: false
      generate:
        apiVersion: gateway.envoyproxy.io/v1alpha1
        kind: SecurityPolicy
        name: oidc-policy-{{ "{{request.object.metadata.name}}" }}
        namespace: {{ "{{request.object.metadata.namespace}}" | quote }}
        synchronize: true
        data:
          apiVersion: gateway.envoyproxy.io/v1alpha1
          kind: SecurityPolicy
          metadata:
            name: oidc-policy-{{ "{{request.object.metadata.name}}" }}
            namespace: {{ "{{request.object.metadata.namespace}}" | quote }}
          spec:
            targetRef:
              group: gateway.networking.k8s.io
              kind: HTTPRoute
              name: {{ "{{request.object.metadata.name}}" | quote }}
            oidc:
              provider:
                issuer: {{ required "policies.envoyOidc.issuer is required when enabled" .Values.policies.envoyOidc.issuer | quote }}
              redirectURL: "https://{{ "{{request.object.spec.hostnames[0]}}" }}/oauth2/callback"
              {{- if .Values.policies.envoyOidc.cookieDomain }}
              cookieDomain: {{ .Values.policies.envoyOidc.cookieDomain | quote }}
              {{- end }}
              cookieNames:
                idToken: {{ .Values.policies.envoyOidc.idTokenCookieName | default "id-token" | quote }}
              {{- if .Values.policies.envoyOidc.scopes }}
              scopes:
                {{- range .Values.policies.envoyOidc.scopes }}
                - {{ . | quote }}
                {{- end }}
              {{- end }}
              clientIDRef:
                name: {{ default (required "policies.envoyOidc.clientSecretName is required when enabled" .Values.policies.envoyOidc.clientSecretName) .Values.policies.envoyOidc.clientIDSecretName | quote }}
              clientSecret:
                name: {{ required "policies.envoyOidc.clientSecretName is required when enabled" .Values.policies.envoyOidc.clientSecretName | quote }}
            {{- if .Values.policies.envoyOidc.emailWhitelist }}
            authorization:
              defaultAction: Deny
              rules:
                - action: Allow
                  name: allow-whitelisted-emails
                  principal:
                    jwt:
                      provider: {{ .Values.policies.envoyOidc.jwtProviderName | default "google" | quote }}
                      claims:
                        - name: email
                          values:
                            {{- range .Values.policies.envoyOidc.emailWhitelist }}
                            - {{ . | quote }}
                            {{- end }}
            jwt:
              providers:
                - name: {{ .Values.policies.envoyOidc.jwtProviderName | default "google" | quote }}
                  issuer: {{ required "policies.envoyOidc.issuer is required when enabled" .Values.policies.envoyOidc.issuer | quote }}
                  remoteJWKS:
                    uri: {{ required "policies.envoyOidc.remoteJWKS.uri is required when emailWhitelist is set" .Values.policies.envoyOidc.remoteJWKS.uri | quote }}
                    {{- if .Values.policies.envoyOidc.remoteJWKS.cacheDuration }}
                    cacheDuration: {{ .Values.policies.envoyOidc.remoteJWKS.cacheDuration }}
                    {{- end }}
                  extractFrom:
                    cookies:
                      - {{ .Values.policies.envoyOidc.idTokenCookieName | default "id-token" | quote }}
            {{- end }}
{{- end }}
