# Homelab Kubernetes Cluster

Talos Linux cluster with GitOps managed by Argo CD.

## Stack

- **OS:** Talos Linux 1.12.0
- **Orchestration:** Kubernetes v1.34.1
- **Networking:** Cilium CNI with LB-IPAM
- **GitOps:** Argo CD
- **Ingress:** Envoy Gateway (Gateway API)
- **DNS:** external-dns (Cloudflare)
- **Storage:** Longhorn
- **Secrets:** Sealed Secrets
- **Policy Engine:** Kyverno
- **Monitoring:** kube-prometheus-stack (Prometheus, Grafana, Alertmanager)
- **Auth:** Envoy Gateway OIDC via `SecurityPolicy` (generated by Kyverno)

## Network

- Control Plane: 10.0.0.10
- Worker: 10.0.0.11
- LoadBalancer Pool: 10.0.1.0/24

## Structure

```
talos/          # Machine configs, secrets, patches (NEVER commit configs!)
apps/           # Argo CD applications
  argocd/       # Argo CD self-management
  platform/     # Platform services (gateway, DNS)
  infrastructure/ # Infrastructure services (Cilium)
manifests/      # Direct Kubernetes manifests
```

## Security Notice

⚠️ **Sensitive files are excluded from Git:**
- `talos/secrets.yml` - Cluster secrets and certificates
- `talos/talosconfig` - Admin credentials
- `talos/controlplane.yaml` - Machine config with embedded secrets
- `talos/worker.yaml` - Machine config with embedded secrets
- `kubeconfig` - Kubernetes admin credentials

Use `talos/rotate-secrets.sh` to generate fresh configs.

## Quick Start

See [SETUP.md](SETUP.md) for installation details.

## Bootstrap

1. Install Argo CD:
```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

2. Deploy this repo's applications:
```bash
kubectl apply -f apps/argocd/application.yaml
kubectl apply -f apps/root-app.yaml
```

3. Access UI (admin password):
```bash
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
```

## Security

Never commit these files:
- `kubeconfig` - Cluster credentials
- `talos/secrets.yml` - Talos secrets
- `talos/talosconfig` - Talos configuration

Create secrets manually:
```bash
kubectl create secret generic cloudflare-api-token \
  -n external-dns \
  --from-literal=token=YOUR_TOKEN
```

Vault instructions:
```bash
kubectl exec -n vault vault-0 -- vault operator init -key-shares=1 -key-threshold=1
kubectl exec -n vault vault-0 -- vault operator unseal <SECRET>
kubectl exec -n vault vault-1 -- vault operator raft join http://vault-0.vault-internal:8200
kubectl exec -n vault vault-1 -- vault operator unseal <SECRET>
```

## OIDC (Envoy Gateway)

Routes opt-in to OIDC by adding this label to their `HTTPRoute`:

- `auth.joeriberman.nl/oidc: "true"`

In this repo’s wrapper charts, you can usually enable this by setting the route value (which adds the label automatically):

- `route.oidc.enabled: true`

Kyverno generates an Envoy Gateway `SecurityPolicy` in the same namespace as the labeled `HTTPRoute`, targeting that route by name.

Configuration lives in:

- [apps/platform/kyverno/values.yaml](apps/platform/kyverno/values.yaml) (`policies.envoyOidc.*`, especially `enabled` + `issuer`)

Notes:

- The OIDC client Secret is expected in the `envoy-gateway` namespace (default name: `envoy-oidc`).
- The redirect URL is fixed to `https://auth.joeriberman.nl/oauth2/callback` and the `auth.joeriberman.nl` host is routed through Envoy Gateway.
- A `ReferenceGrant` in `envoy-gateway` is generated automatically per opting-in namespace so the generated `SecurityPolicy` can reference the central Secret.
